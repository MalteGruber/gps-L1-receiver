

class NavigationMessageHandler:
    
    
    def __init__(self):
        pass
        self.bitstream=""
        self.rp=0
        self.preamble="10001011"
        
        print(self.invert(self.preamble)+"<")
        print((self.preamble)+"<")
        self.data_bits="0"*30
        self.D29prev="0"
        self.D30prev="0"

    def invert(self,bitstring):
        
        tmp=""
        for s in bitstring:
            if(s=="0"):
                tmp+="1"
            else:
                tmp+="0"
        return tmp
    
    """
    Scanns for preamble and puts rp at end of preamble
    """
    def scan_for_preamble(self):
        possible="00000000"
        
        self.preamble_inv=self.invert(self.preamble)
        
        for i in range(len(self.bitstream)-self.rp):
            
            possible=possible[1:]+self.bitstream[self.rp]
            #print(possible)
            if possible == self.preamble_inv:
                self.bitstream=self.invert(self.bitstream)
                print("Found inverted preamble @",self.rp)
                return True
            if possible == self.preamble:
                print("Found good preamble @",self.rp)
                return True
            self.rp+=1
            
        return False
            
    """
    Assumes that we are at the begining of a word
    """
    def calc_xor(self,a,b):
        a=a=="1"
        b=b=="1"
        xor=a!=b
        if(xor):
            return "1"
        else:
            return "0"
        
    def calc_xor_sum(self,d0,offsets):     
        count=0
        for o in offsets:  
            if(self.bits(o-1, 1))=="1":
                count+=1
        if(d0=="1"):
            count+=1
        if(count%2>0):
            return "1"
        return "0"
    
    
    """
    rp must be at start of word
    """
    def calculate_parity_bits(self):
        
        D29p=self.D29prev
        D30p=self.D30prev
        received_parity=self.bits(24,6)       
        data_bits=self.bits(0,23)
         
        D25=self.calc_xor_sum(D29p, [1,2,3,5, 6,10,11,12 ,13,14,17, 18,20,23])
        D26=self.calc_xor_sum(D30p, [2,3,4,6, 7,11,12,13, 14,15,18, 19,21,24])
        D27=self.calc_xor_sum(D29p, [1,3,4,5, 7,8,12,13,  14,15,16, 19,20,22])
        D28=self.calc_xor_sum(D30p, [2,4,5,6, 8,9,13,14,  15,16,17, 20,21,23])
        D29=self.calc_xor_sum(D30p, [1,3,5,6, 7,9,10,14,  15,16,17, 18,21,22,24])
        D30=self.calc_xor_sum(D29p, [3,5,6,8, 9,10,11,13, 15,19,22, 23,24])
 
        
        if(D30p=="1"):
            data_bits=self.invert(self.data_bits) 
            
            
        calculated_parity=D25+D26+D27+D28+D29+D30
        
     #   
       # 
        #print("Parity  bits\t",calculated_parity,"D29,D30",D29p,D30p)
        #print("received_parity\t",received_parity)
      #  print("--")
        

        #print("Now: ",D29p,D30p,"from ",self.D29prev,self.D30prev)
        self.D29prev=received_parity[4]
        self.D30prev=received_parity[5]
        #print("Nxt: ",self.D29prev,self.D30prev,"from ",self.bitstream[self.rp+28:self.rp+30])
        
        if calculated_parity==received_parity:
            return True,data_bits
        else:
            return False,data_bits
        
            
    def bits(self,start,count):
        v=""
        try:
            v=self.bitstream[self.rp+start:self.rp+start+count]
        except:
            print("FAUIL:",start,self.rp)
        
        return v
    
    
    def parse_message_001(self,words):
        pass
    
    def parse_message(self,words):
        how=words[1]
        subframe=how[20:23]
        print("Subframe ",subframe)
        
        if(subframe=="001"):
            self.parse_message_001(words)
            
    def parse_frame(self):
        
        
        
        pushed_rp=self.rp
        self.rp-=7
        
        self.D29prev="0"
        self.D30prev="0"
        
        words=[]
        pok=True
        for i in range(10):    
            ok,data=self.calculate_parity_bits()
            if(i<1):
                pok=pok and ok
            words.append(data)
            self.rp+=30
        
        if(pok):
            print("PARITY OK! :D\tPARITY OK! :D\tPARITY OK! :D"*3)
            self.parse_message(words)
           # print("sub_frame_id",sub_frame_id)
        else:
            #Revert and continue scanning..
            self.rp=pushed_rp-9
            
        week=self.bits(start=0, count=10)
 #       print("sub_frame_id",sub_frame_id)
#        print("week",week)
    
        
    def parse_bits(self):
        
        while(self.scan_for_preamble()):
            try:
                self.parse_frame()
            except:
            
                print("FAUIL:",self.rp)
        
            
            self.rp+=10
            pass
        
        
            
        
        
        
    def push_bits(self,bits):
        
        self.bitstream+=bits
        print(len(bits),"bits",0.05*len(bits),"seconds")
        self.parse_bits()



n=NavigationMessageHandler()

#11
#n.push_bits("01000001100110000111100100001110101101110100111101001110011111101110001001111111011011010101100001000011110110110110111000010101101111111001010010100110110000000010101100101111111111110101011110111100111010001001100101100111000100000110100011")

#1
#n.push_bits("00100001011001011100110011000011110010000111010110111010011101111010010110011011000100000000010010010001010111011001111011011011011100001010110111111100101001010011011001111110101001101000000000000101010000100001100010111011001")
#n.push_bits("110110110011000011110010000111010110111010011101111010010110011011000100000000010010010001010111011001111011011011011100001010110111111100101001010011011001111110101001101000000000000101010000100001100010111011001101001100011101111100101110000000000100000011100111100110000111010110010101010100001101010011110111111111111110010101001110111010011101111010010110011011000100000000000001")

#1 but with     b=read_data_spain_complex(2000+1000*4000,N)
#n.push_bits("1001010100110010011101111111110110110111010100010011000010010010010001111010100100000001101011010110010011000000101011001011111111111101010111101111001110100010011001011001110001000001101000111111111101111110001100001100111100010100110101010101111001010110000100000000000000110101")

#20
#n.push_bits("1100100111111011100011111111101001001010100111101111000010010010010001100101011011111111101011001001101100110000101011001000001111111101")

#32 a bit noisy at start:
#n.push_bits("1111010010011000010010000000001001001101011000010011000010010010000111111000011110110001101011010001011010111111010100100000000000011011010111101111001110100010110000100110001111011011010000101101111101111110111100110000111110010101000010111010010111101100000100000000000000010000110000100010110000101100011000000100011101111111111000100100010000101100011001000000000000111111110110001110111101111100001100111000100100100101000000011101110111111001110000111110101001100000100111010100000110010001110111001010010010010111110000000000001111111111101001110111010001111101010001111100010000100010110000101100011000000100011101111111111010101001111000001000110000000111010000011010001101100111110101110011110101110000101101011100101001111110000000010111110000000101010101000100110000010000011110110100000011100000011010100001001111111100100011110001110000010010010110110110100001111100001100100010110000101100011000000100011101111111111100101100001000111111111010110000011011001111101101100101011010101111110010000000000101101100100110101001010011011001")


#sat 1 looong frun
#n.push_bits("0110010000101101100010000000010110110111010100010011000010010010010001111010100100000001101011010110010011000000101011001011111111111101010111101111001110100010011001011001110001000001101000111111111101111110001100001100111100010100110101010101111001010110000100000000000000110101011000100010110001000010110100110010011101111111111000100110011100101100011001000000000000111111110110001110111101111100001100111000100100100101000000011101110111111001110000111110101001100000100111010111101101111100000010110101101101101000110010000000000000000000011110111101111111100100011110110010010100100010110001000010110100110010011101111111111010101011110100000010110000000101110101101001110011001011000010001001111110011110010001110001001111111010000000010101011000000000011110110111110011011011000010111101111010101010101101011110111001111100100110011111011100101110010110110110100001010101010000100010110001000010110100110010011101111111111100101110000100111111111110110011101101100011110111111001010111001001000011111111111110111111011000100011110111100011010010000101110110010101101100110000")
#11
#n.push_bits("1001111110001011100010000000110110110101011000010011000010010010010001111010100100000001101011010110010011000000101011001011111111111101010111101111001110100010011001011001110001000001101000111111111101111110001100001100111100010100110101010101111001010110000100000000000000110111011000100010110000100011100111111011100010000000000111100100010000100011100110111111111111000000001001110001000101111100001100111000100100101010111111100010001000000")


#sat 32, 15900
#n.push_bits("0000100110010111101110010001000101001000101100001011011001111110111000100000000010010010101001111011001111011011011110000001111000010011100101001011101001010000001010110111111111111001001010000100001100010111010011110110011100001001001011110100100000100000010000110011110000011010101111010001011010000100111110111111111111111011110011110111010011110100111001111110111000100000000001110110111011110100111001101111111111110000000010011100010000100000111100110001110110110110101111111000100010000001100011110000010101100111110110001010111110011011100010001101011011011010000011111111111100000000000101100010001011100000101011100000111011110111010011110100111001111110111000100000000001010101100001111101110011111110001011111001011100100110000010100011000010100011110100101000110101100000011111111010000011111110101010101110110011111011111000010010111111000111111001010111101100000000110111000011100011111011011010010010010111100000111100110111010011110100111001111110111000100000000000110100111101110000000001010011111001001100000100100110101001010100000011011111111110100100110110010101101011001001100001101011101001011110000110000101000011111000010110000010101111000000011011010000000001011001000010100011100010001111110101101010110001110111010011110100111001111110111000100000000000010011101100111000101101010101010101010000110101010101010101010101010000110101010101010101010101010000110101010101010101010101010000110101010101010101010101010000110101010101010101010101010000110101010101010101010101010000110101010101010101010101010000110111010011110100111001111110111000011111111111110010000010111011001011010101111011010001000111101100011001101001000101001111110101010110000000000101101010000100001101110011001100011011100110010000100001110111100101010010000101100100000010110011101110111100110110010100111110111011111111111110000100110111010011110100111001111110111000011111111111010110111101110100111001101111111111110000000010011100010000100000111100110001110110110110101111111000100010000001100011110000010101100111110110001010111110011011100010001101011011011010000011111111111100000000000101100010001011100000101011100000111011110111010011110100111001111110111000011111111110110101011001111101110011111110001011111001011100100110000010100011000010100011110100101000110101100000011111111010000011111110101010101110110011111011111000010010111111000111111001010111101100000000110111000011100011111011011010010010010111100000111100110111010011110100111001111110111000011111111110010100111011110000000001010011111001001100000100100110101001010100000011011100000001011011001001101010010100110110011110010100010110100001111001111010111100000111101001111101010000111111100100101111111110100110111101011100011101110011110101101010110001110111011101101")

# sat 1
#3000 sv 27:
#n.push_bits("110010001101110011011010001011101111000110100001011101110100100010001011011001111110001100110100111011101011100001000000000111110001100110110000101011100000110110111111110010111101001001100000000100000011111011001000010111100100010110000111111000100011111010101011100011001001001011100010001100000101010001000001011111100001110101110001110100010111111010101011000000000111111010111101111001000111101011111000011100111100111011000001001001100011010110110001110011010001001101101000111111010111111110101110000000000111010011000100010110000111111000100011111010101011100010111011000010100111111000101000000000000111010010110001001100001010111001111011110100100110000010001000101001100110011000100011010111101110111010111011111111011000110010000001000000001010010100001111111110000000000110110111000111110101100100010100011011100100010110000111111000100011111010101011100010101010101111100010000000000001010001101000011110100110000111011010000001101010100110001101100100110001001111111010101001011111100000001101111101011110001010111110100000100110101000010100001111100000011011010101101100000100100100000000101001001111100110100100010110000111111000100011111010101011100010011010000001100000000000001010111001011111100110010110011011110101110000111111111111100101111011000101100110110100001101101111111001111111001011101110011101110001001101100010000100110100000011001000000000101011110010110000101101111110000000001110000010000100010110000111111000100011111010101011100010001001101001000010111010000010100001010111110000011110001101110101101000011000000101001111111111111000001010111101111001110101000101010110010011000101010000111101011110000001000000001100101010110100011101010010100100101000110001001111111111111011100101000100010110000111111000100011111010101011100001111001010111100010001110110001101001010010110000011110000100101100111000011000000101011100111111111010001010111101111001101101110010000011100100100100011111010000101011001010000011110001111000010000000000111011000100100110000000010001111111111000000000100100010110000111111000100011111010101011100001101011001000000111111000101000000000000111010010110001001100001010111001111011110100100110000010001000101001100110011000100011010111101110111010111011111111011000110010000001000000001010010100001111111110000000000110110111000111110101100100010100011011100100010110000111111000100011111010101011100001011010111010000010000000000001010001101000011110100110000111011010000001101010100110001101100100110001001111111010101001011111100000001101111101011110001010111110100000100110101000010100001111100000011011010101101100000100100100000000101001001111100110100100010110000111111000100011111010101011100001001010001011000000000000001010111001011111100110010110011011110101110000111111111111100101111011000101100110110100001101101111111001111111001011101110011101110001001101100010000100110100000011001000000000101011110010110000101101111110000000001110000010000100010110000111111000100011111010101011100000111001110101000010111100001110")
#3000 sv 20:

#6000!! sv 20 :D
n.push_bits("111101010101000111010101010011111011010111011110110011010110100100011100110011010110011001110001100010000111100010111001000001111011110110010000000101011011011010110101110010000011010011111000000010011010111101000111111001010100011000000011010110111111110101101100000110010110111010011110000001110111000001010101000111011001011111100110000000000010101111000110011110111100111101011100010010101111111111111011100110110100111101110000110001111000110001011100001101101001110010110100111111010001100110111111110110111010000000001011101010110101011100101111011111011111011101101110111010011110000001110111000001010101000111011101100101101111010001011111010111101010000011111000011100100010100101111001111110101100000000000001111101010000100001100010101110101010011011001110101011110000101000011111101111111100110101010010111000101011010110110101110011101100000000000001000110101110111010011110000001110111000001010101000111100001101010000111011100010011100101101011010011111000011110110100110001111001111110101000110000000001011101010000100001100100100011011111000110110110111000001011110101001101011111000011100001111011111111110001001110110110011111111011100000000001111111110110111010011110000001110111000001010101000111100101001101111110000001110101111111111110001011010011101100111101010001100001000010110110011111011101110101100110011001110111001010000100010001010001000111011100001111010000101111111101011011010011111111111111111111110110111011011101111000110111010100110110111010011110000001110111000001010101000111101001010001011111010000100001001100101000100100011100110"+
            "011010110011001110001100010000111100010111001000001111011110110010000000101011011011010110101110010000011010011111000000010011010111101000111111001010100011000000011010110111111110101101100000110010110111010011110000001110111000001010101000111101101011101001110000000000010101111000110011110111100111101011100010010101111111111111011100110110100111101110000110001111000110001011100001101101001110010110100111111010001100110111111110110111010000000001011101010110101011100101111011111011111011101101110111010011110000001110111000001010101000111110001100010101111010000111100010101111011101111111000000000000000001101010110000001011000111111111111001110101111011110011010001101101100111001110000101110100011100010111101001101101100010000111000000000001101010000011011111101111110011111111110011100110110111010011110000001110111000001010101000111110101101110111111011011111011110111011111101111111000011101110001001111010001111110101010001000000001110010101111011110010111101001001110011100110010010101100010110010001000000101010000101011011101000001010000101111100010111001110111100000000000010011011110111010011110000001110111000001010101000111111001001110110110000001110101111111111110001011010011101100111101010001100001000010110110011111011101110101100110011001110111001010000100010001010001000111011100001111010000101111111101011011010011111111111111111111110110111011011101111000110111010100110110111010011110000001110111000001010101000111111101010101100111010000100001001100101000100100011100110011010110011001110001100010000111100010111001000001111011110110010000000101011011011010110101110010000011010011111000000010011010111101000111111001010100011000000011010110111111110101101100000110010110111010011110000001110111000001010101001000000001011000000110000000000010101111000110011110111100111101011100010010101111111111111011100110110100111101110000110001111000110001011100001101101001110010110100111111010001100110111111110110111010000000001011101010110101011100101111011111011111011101101110111010011110000001110111000001010101001000000101100010001111010000010110100111100001111000000111100001100011001110110101111110101001011000000000010101010000100001110000011100100011000110100101010111011001010010000000111010001110000000111101111000101"+
            "000001111001110000000000100111111111111001000110110111010011110000001110111000001010101001000001001101001101111011011011110011111100010100100000111100000110010010100001101111110101010001000000000100001010000100001101101011100101100100011001101010001110011100000100010001111110010101011100110111101110111111111001101010000011111011111111111101011000110111010011110000001110111000001010101001000001101001110010110000001110101111111111110001011010011101100111101010001100001000010110110011111011101110101100110011001110111001010000100010001010001000111011100001111010000101111111101011011010011111111111111111111110110111011011101111000110111010100110110111010011110000001110111000001010101001000010001010000101111010000100001001100101000100100011100110011010110011001110001100010000111100010111001000001111011110110010000000101011011011010110101110010000011010011111000000010011010111101000111111001010100011000000011010110111111110101101100000110010110111010011110000001110111000001010101001000010101011100111110000000000010101111000110011110111100111101011100010010101111111111111011100110110100111101110000110001111000110001011100001101101001110010110100111111010001100110111111110110111010000000001011101010110101011100101111011111011111011101101110111010011110000001110111000001010101001000011001100001000111001111111101100010011100110011111000011110110111001110100001111110101010100000000000010010101111011110010011111000101111011100101010111001000110010001001010011001001011010110111010110110011010010110010010100001101100100000000101001010001110111010011110000001110111000001010101001000011101101101010111011010111011101111011010110011111000011110011001100001001010000001010111010111111111010010101111011110011001001101101000001110000110000111000000000001000110111110010000001101000110011011010011001110010110011100001001011111111110111110000110111010011110000001110111000001010101001000100001001001010110000001110101111111111110001011010011101100111101010001100001000010110110011111011101110101100110011001110111001010000100010001010001000111011100001111010000101111111101011011010011111111111111111111110110111011011101111000110111010100110110111010011110000001110111")
if False:
    #Reference
    #                                       |----|
    n.push_bits("00"+"100010110000000000000011"+"100100"+
                "101001101110100000000101"+"001100"+
                "010111001101000100000000"+"100010")

